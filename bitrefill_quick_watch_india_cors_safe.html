<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitrefill Gift Card Monitor</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .refresh-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: #64748b;
        }

        .error {
            text-align: center;
            padding: 4rem;
            color: #dc2626;
        }

        .table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .category-select {
            min-width: 200px;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background: white;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .gift-card-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .gift-card-table th {
            background: #f1f5f9;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
        }

        .gift-card-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }

        .table-row:hover {
            background: #f8fafc;
        }

        .product-info {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .product-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            object-fit: contain;
        }

        .product-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .category-tag {
            background: #e2e8f0;
            color: #475569;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
            display: inline-block;
        }

        .stock-status {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stock-status.in-stock {
            background: #dcfce7;
            color: #166534;
        }

        .stock-status.out-of-stock {
            background: #fef2f2;
            color: #dc2626;
        }

        .commission-value {
            font-weight: 500;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .star {
            color: #fbbf24;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-title {
                font-size: 2rem;
            }
            
            .table-controls {
                flex-direction: column;
            }
            
            .search-input,
            .category-select {
                min-width: unset;
            }
        }
  </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
      <div>
                <h1 class="header-title">Bitrefill Gift Card Monitor</h1>
                <p class="header-subtitle">Track gift card prices and commissions in real-time</p>
            </div>
            <button class="refresh-button" onclick="loadData()">
                ðŸ”„ Refresh
            </button>
        </div>
    </div>

    <div class="main-content">
        <div id="loading" class="loading" style="display: none;">
            <h3>Loading Gift Card Data...</h3>
            <p>Fetching the latest prices and commission data...</p>
      </div>

        <div id="error" class="error" style="display: none;">
            <h3>Error Loading Data</h3>
            <p id="error-message"></p>
            <button class="refresh-button" onclick="loadData()">Try Again</button>
      </div>

        <div id="table-container" class="table-container" style="display: none;">
            <div class="table-header">
                <div class="table-controls">
                    <input type="text" id="search" class="search-input" placeholder="Search gift cards..." onkeyup="filterTable()">
                    <select id="category" class="category-select" onchange="filterTable()">
                        <option value="all">All Categories</option>
        </select>
                </div>
                <div id="table-info">Showing 0 gift cards</div>
    </div>

            <div class="table-wrapper">
                <table class="gift-card-table">
          <thead>
                        <tr>
                            <th onclick="sortTable('productName')">Product Name</th>
                            <th>Price Range</th>
                            <th>USD Rate</th>
                            <th onclick="sortTable('commission')">Commission</th>
                            <th>Stock Status</th>
                            <th onclick="sortTable('rating')">Rating</th>
                            <th onclick="sortTable('reviews')">Reviews</th>
            </tr>
          </thead>
                    <tbody id="table-body">
                    </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
        let giftCardsData = [];
        let filteredData = [];
        let sortField = 'productName';
        let sortDirection = 'asc';

        // Sample data structure based on the API response
        const sampleData = [
            {
                productName: "Phonepe India",
                priceRange: "â‚¹100 - â‚¹5000",
                usdRate: 88.28,
                commission: "8.5%",
                stockStatus: "In Stock",
                rating: 4.8,
                reviews: 38,
                categories: ["ecommerce", "utility-bills"],
                iconPreview: "data:image/webp;base64,UklGRm4AAABXRUJQVlA4TGEAAAAvF8AFACcgEEj80VpqDYFA4m/YNB/9f/7jhyIAGESS5GTv7gVEASQHYICv9W+K55OCiP5PAFd99G2g+JYLpYG6tVwoNYfv1uQrNH+bZ915unkZLRd2/SOAhhy0gXTDrqbZAA=="
            },
            {
                productName: "Swiggy Money India",
                priceRange: "â‚¹50 - â‚¹10000",
                usdRate: 88.28,
                commission: "12.3%",
                stockStatus: "In Stock",
                rating: 5.0,
                reviews: 17,
                categories: ["food", "food-delivery"],
                iconPreview: "data:image/webp;base64,UklGRm4AAABXRUJQVlA4IGIAAACwBACdASoYABgAP1mYw1eyKqejqA1SQCsJbAAALo3Vipgyc3H5F8J77K6trvAAAP7nH+Qi051ZVHr6dlukkc61mucRUEQI0j16Qd+nj4kYCeuaGDzlyAaQJ6/rHFyQW4AAAA=="
            },
            {
                productName: "Flipkart India",
                priceRange: "â‚¹5000",
                usdRate: 88.28,
                commission: "N/A",
                stockStatus: "Out of Stock",
                rating: 4.7,
                reviews: 35,
                categories: ["ecommerce", "health-beauty", "home", "electronics"],
                iconPreview: "data:image/webp;base64,UklGRpQAAABXRUJQVlA4IIgAAAAwBQCdASoYABgAP0WGu1awKKYjt/qoAgAoiWwAsQ0g9j0DGQbEP+/kNJJj6nwaDIMgAAD+5xmSgkeu18Sx4ZGinSh/Ox3fUJluU6aVUSSFQwkOKsTUPtpG0BR1IGoyeZRo+8vmNqMx39TSK5ZAC/BLDHvNKrjJeXYsfWAnS95RW3YdSgQ42sAA"
            },
            {
                productName: "Google Play India",
                priceRange: "â‚¹50 - â‚¹5000",
                usdRate: 88.28,
                commission: "15.2%",
                stockStatus: "In Stock",
                rating: 4.8,
                reviews: 64,
                categories: ["games", "entertainment"],
                iconPreview: "data:image/webp;base64,UklGRngAAABXRUJQVlA4IGwAAABwBACdASoYABgAP0mEvFawKCYjt/qoAgApCWwAAEqUc8qMPQRA5adpWEsK4AD+50CSb+EhueT3dKg9k0s9nFGhp1BxQjN8/JFyVnkO0HUwsUngEXqno039O3guy/IhWES2FFnMiUrx92YaAAA="
            },
            {
                productName: "Zomato India",
                priceRange: "â‚¹500 - â‚¹10000",
                usdRate: 88.28,
                commission: "6.8%",
                stockStatus: "In Stock",
                rating: 4.3,
                reviews: 12,
                categories: ["food", "restaurants", "food-delivery"],
                iconPreview: "data:image/webp;base64,UklGRmIAAABXRUJQVlA4IFYAAADQAwCdASoYABgAP1maxFiyKyejsBgIAkArCUAXYAEBUy1yK6kL8AAA/RwRoWgRribeNQpGpD1jEXQv5JepPyrzbjat59FntE1PdsP4j0gC4u8yBjAAAA=="
            }
        ];

        function processGiftCard(card, fxRates, productDetail = null) {
            // Calculate USD rate (1 USD = 1 / INR_USD_RATE)
            const inrToUsdRate = 1 / fxRates.INR.USD;
            
            // Use productDetail if available, otherwise use card data
            const packages = productDetail?.packages || card.packages || [];
            const outOfStock = productDetail?.outOfStock || card.outOfStock || false;
            const label = productDetail?.label || card.label || '';
            
            // Calculate commission
            let commission = 'N/A';
            if (packages && packages.length > 0) {
                const commissions = packages.map(pkg => {
                    const usdPriceInINR = pkg.usdPrice * inrToUsdRate;
                    const commissionAmount = usdPriceInINR - parseFloat(pkg.value);
                    const commissionRate = (commissionAmount / parseFloat(pkg.value)) * 100;
                    return {
                        value: pkg.value,
                        commissionRate: Math.round(commissionRate * 100) / 100,
                        usdPriceInINR: Math.round(usdPriceInINR * 100) / 100
                    };
                });
                
                // If all packages have the same commission rate, return a single string
                const uniqueRates = Array.from(new Set(commissions.map(c => c.commissionRate)));
                if (uniqueRates.length === 1) {
                    commission = `${commissions[0].commissionRate}%`;
                } else {
                    // If different rates, return array of details
                    commission = commissions;
                }
            }
            
            // Determine stock status
            let stockStatus = 'In Stock';
            if (label === 'out_of_stock' || outOfStock) {
                stockStatus = 'Out of Stock';
            }
            
            return {
                productName: card.name,
                priceRange: card._priceRange,
                usdRate: inrToUsdRate,
                commission: commission,
                stockStatus: stockStatus,
                rating: card._ratingValue || 0,
                reviews: card._reviewCount || 0,
                categories: card.categories || [],
                iconPreview: card.iconPreview
            };
        }

        async function loadData() {
            showLoading();
            hideError();
            hideTable();

            try {
                // Use CORS proxy to avoid CORS issues
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                
                // Fetch basic data first (gift cards and FX rates)
                const [giftCardsResponse, fxRatesResponse] = await Promise.all([
                    fetch(corsProxy + encodeURIComponent('https://www.bitrefill.com/api/omni?c=all-gift-cards&country=IN')),
                    fetch(corsProxy + encodeURIComponent('https://www.bitrefill.com/api/accounts/fx_rates'))
                ]);
                
                if (!giftCardsResponse.ok || !fxRatesResponse.ok) {
                    throw new Error('Failed to fetch data from APIs');
                }
                
                const giftCardsDataRaw = await giftCardsResponse.json();
                const fxRatesData = await fxRatesResponse.json();
                
                const rawGiftCards = giftCardsDataRaw.products || [];
                const fxRates = fxRatesData;
                
                // Process initial gift cards without detailed product info
                giftCardsData = rawGiftCards.map(card => processGiftCard(card, fxRates));
                filteredData = [...giftCardsData];
                
                populateCategories();
                renderTable();
                showTable();
                updateTableInfo();
                
                // Now fetch detailed product information in the background
                // and update cards as we get the data
                const updatedCards = [...giftCardsData];
                
                // Process products in batches to avoid overwhelming the API
                const batchSize = 5;
                const productIds = rawGiftCards.map(card => card._id);
                
                for (let i = 0; i < productIds.length; i += batchSize) {
                    const batch = productIds.slice(i, i + batchSize);
                    
                    const batchPromises = batch.map(async (productId) => {
                        try {
                            const productDetailResponse = await fetch(corsProxy + encodeURIComponent(`https://www.bitrefill.com/api/product/${productId}`));
                            if (productDetailResponse.ok) {
                                const productDetail = await productDetailResponse.json();
                                
                                // Update the specific card with detailed information
                                const cardIndex = updatedCards.findIndex(card => 
                                    card.productName === rawGiftCards.find(gc => gc._id === productId)?.name
                                );
                                
                                if (cardIndex !== -1) {
                                    const originalCard = rawGiftCards.find(gc => gc._id === productId);
                                    if (originalCard) {
                                        updatedCards[cardIndex] = processGiftCard(originalCard, fxRates, productDetail);
                                        giftCardsData = [...updatedCards];
                                        filteredData = [...updatedCards];
                                        renderTable();
                                        updateTableInfo();
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn(`Failed to fetch details for ${productId}:`, error);
                            // Continue with other products even if one fails
                        }
                    });
                    
                    await Promise.all(batchPromises);
                    
                    // Small delay between batches to be respectful to the API
                    if (i + batchSize < productIds.length) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to load gift card data. This might be due to CORS restrictions. Please try using a CORS browser extension or run this from a local server. Error: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').style.display = 'block';
            hideLoading();
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showTable() {
            document.getElementById('table-container').style.display = 'block';
            hideLoading();
        }

        function hideTable() {
            document.getElementById('table-container').style.display = 'none';
        }

        function populateCategories() {
            const categorySelect = document.getElementById('category');
            const categories = [...new Set(giftCardsData.flatMap(card => card.categories))];
            
            // Clear existing options except "All Categories"
            categorySelect.innerHTML = '<option value="all">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categorySelect.appendChild(option);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedCategory = document.getElementById('category').value;
            
            filteredData = giftCardsData.filter(card => {
                const matchesSearch = card.productName.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || card.categories.includes(selectedCategory);
                return matchesSearch && matchesCategory;
            });
            
            renderTable();
            updateTableInfo();
        }

        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let aValue = a[field];
                let bValue = b[field];
                
                if (field === 'commission') {
                    aValue = aValue === 'N/A' ? -1 : parseFloat(aValue);
                    bValue = bValue === 'N/A' ? -1 : parseFloat(bValue);
                }
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            filteredData.forEach(card => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                
                row.innerHTML = `
                    <td>
                        <div class="product-info">
                            ${card.iconPreview ? `<img src="${card.iconPreview}" alt="${card.productName}" class="product-icon" onerror="this.style.display='none'">` : ''}
                            <div>
                                <div class="product-name">${card.productName}</div>
          <div>
                                    ${card.categories.slice(0, 2).map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                                    ${card.categories.length > 2 ? `<span class="category-tag">+${card.categories.length - 2}</span>` : ''}
            </div>
          </div>
        </div>
                    </td>
                    <td>${card.priceRange}</td>
                    <td>â‚¹${card.usdRate.toFixed(4)}</td>
                    <td><span class="commission-value">${card.commission}</span></td>
                    <td><span class="stock-status ${card.stockStatus.toLowerCase().replace(' ', '-')}">${card.stockStatus === 'In Stock' ? 'âœ“ In Stock' : 'âœ— Out of Stock'}</span></td>
                    <td>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>${card.rating.toFixed(1)}</span>
        </div>
                    </td>
                    <td>${card.reviews}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateTableInfo() {
            document.getElementById('table-info').textContent = 
                `Showing ${filteredData.length} of ${giftCardsData.length} gift cards`;
        }

        // Load data on page load
        window.onload = loadData;
  </script>
</body>
</html>
